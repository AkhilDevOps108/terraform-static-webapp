# azure-swa-hugo-blog

Code to deploy and maintain an Azure Static Webapp running a static web site generated with Hugo and GitHub Actions.

## Summary

The code in this repository is meant to deploy the resources to host a static website generated by Hugo on Azure Web Apps. You will need the following to deploy successfully:

* Terraform installed locally
* Azure CLI installed locally
* Hugo installed locally for testing
* Azure subscription
* Registered domain name for website

### Azure Infrastructure

The infrastructure folder has Terraform files in it to deploy the necessary resources to host the website. It includes the following:

* Resource group
* Static site
* Static site custom domain
* Storage account and container
* Log analytics workbook and diagnostic settings
* CDN endpoints (optional)
* DNS zone, CNAME, and TXT validation record
* API Token for website deployment and updates from GitHub Actions

More information is found in the deployment section for the infrastructure.

### Blog website

This repository has the Hugo blog website theme _NAMEHERE_. You don't have to use that theme as long as you drop the correct theme into the `website` directory. The GitHub Actions will assume that's where it is.

Speaking of which, the GitHub Actions will fire when there's a PR against the default branch to create a temporary site for validate and again when there's a push to the default branch to update the production site.

You will need to set the following GitHub Secrets for actions to work properly.

* `AZURE_STATIC_WEB_APPS_API_TOKEN` - An API Token generated by the Terraform deployment.

## Deploy

Before you try to deploy the infrastructure, you have a choice to make. Do you care about the Terraform state beyond the basic deployment. If you're just using this to deploy the infrastructure once and never touch it again, then no worries. You can use the local backend for state data and delete it when you're done. And you can skip the next section.

If you're going to manage the infrastructure with Terraform going forward, then you'll need somewhere to store state data. Since you're already using Azure for everything else, you might as well use it for the state data. The next section describes the steps to create a storage account and container with the Azure CLI that you can use for Terraform state data, and what you have to change in the configuration to use it.

### Store State Data

We are going to create an Azure storage account and container to store our state data and then update the backend block in the `terraform.tf` file to use that storage account.

```bash
# Store website name in a variable for naming, no capitals for punctuation
website_name=YOUR_WEBSITE_DOMAIN_NAME # e.g. 10bitpodcastcom
region=AZURE_REGION_TO_USE # e.g. eastus

## Log in with Azure CLI and select a subscription
az login
az account set -s SUBSCRIPTION_NAME

## Create an resource group
az group create -n "${website_name}tfdata" -l $region

## Create a storage account
az storage account create --name "${website_name}tfdata" --resource-group "${website_name}tfdata" \
  --location $region --sku Standard_LRS

## Create a storage account container
az storage container create -n tfdata --account-name "${website_name}tfdata" \
  --resource-group "${website_name}tfdata"
```

In the `terraform.tf` file uncomment the `backend` block so it looks like this:

```terraform
backend "azurerm" {
    key = "terraform.tfstate"
}
```

We will add in the rest of the values when we run `terraform init`.

### Prepare your Terraform variable values

In the `infrastructure` directory is a file names `terraform.tfvars.example`, rename it to `terraform.tfvars` and fill out the values in the file.